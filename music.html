<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>Music Search</title>

<style>
body {
  background: #121212;
  color: white;
  font-family: Arial, sans-serif;
  padding: 20px;
}

h2 {
  color: #1DB954;
}

input, button {
  padding: 10px;
  font-size: 16px;
  border-radius: 6px;
  border: none;
}

button {
  background: #1DB954;
  color: #fff;
  cursor: pointer;
  transition: 0.2s;
}
button:hover { background: #159c46; }

.result-card {
  background: #1e1e1e;
  padding: 15px;
  border-radius: 8px;
  margin: 10px 0;
  border: 1px solid #333;
}

#scrollArea {
  max-height: 420px;
  overflow-y: auto;
  border-top: 1px solid #333;
  padding-top: 10px;
}

#lyrics {
  background: #1e1e1e;
  padding: 20px;
  border-radius: 8px;
  border: 1px solid #333;
  min-height: 120px;
  white-space: pre-line;
}

#loading {
  display: none;
  margin-top: 10px;
  font-weight: bold;
  color: #1DB954;
}

.spinner {
  width: 20px; height: 20px;
  border: 3px solid #1DB954;
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  display: inline-block;
}
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>

<body>

<h2>Spotify 音樂查詢</h2>

<button onclick="loginWithSpotify()">登入 Spotify</button>

<br><br>
<input id="searchInput" placeholder="輸入歌曲或歌手名稱">
<button onclick="searchSong()">搜尋</button>

<div id="loading"><span class="spinner"></span> Loading…</div>

<h3>歌曲</h3>
<div id="scrollArea"></div>

<hr>

<h2>歌詞</h2>
<div id="lyrics">請選擇歌曲以顯示歌詞</div>

<audio id="audioPlayer" controls style="margin-top:15px; width:100%; display:none;"></audio>

<script>
/* ===== Spotify PKCE ===== */
const clientId = "c1ed4bfc3fbd4fe4bacec9720af2aaed"; 
const redirectUri = "https://yuchang-code.github.io/music.html";

let accessToken = null;
let codeVerifier = null;

async function generateCodeVerifier() {
  const array = new Uint32Array(56);
  crypto.getRandomValues(array);
  codeVerifier = Array.from(array, dec => ("0" + dec.toString(16)).slice(-2)).join("");
  localStorage.setItem("code_verifier", codeVerifier);
}

async function sha256(str) {
  return crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
}

function base64url(buffer) {
  return btoa(String.fromCharCode(...new Uint8Array(buffer)))
    .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
}

async function loginWithSpotify() {
  await generateCodeVerifier();
  const challenge = base64url(await sha256(codeVerifier));

  const url =
    "https://accounts.spotify.com/authorize?" +
    "response_type=code" +
    "&client_id=" + clientId +
    "&code_challenge_method=S256" +
    "&code_challenge=" + challenge +
    "&redirect_uri=" + encodeURIComponent(redirectUri) +
    "&scope=user-read-private";
  
  window.location = url;
}

async function fetchAccessToken(code) {
  const verifier = localStorage.getItem("code_verifier");

  const body = new URLSearchParams({
    client_id: clientId,
    grant_type: "authorization_code",
    code,
    redirect_uri: redirectUri,
    code_verifier: verifier
  });

  const res = await fetch("https://accounts.spotify.com/api/token", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body
  });

  const data = await res.json();
  accessToken = data.access_token;
}

/* ===== 搜尋音樂 ===== */
async function searchSong() {
  const q = searchInput.value.trim();
  if (!q) return;
  if (!accessToken) return alert("請先登入 Spotify");

  loading.style.display = "block";
  scrollArea.innerHTML = "";

  const url = `https://api.spotify.com/v1/search?q=${encodeURIComponent(q)}&type=track&limit=20`;

  const res = await fetch(url, { headers: { Authorization: "Bearer " + accessToken } });
  const data = await res.json();

  loading.style.display = "none";

  const list = data.tracks.items;
  if (!list.length) return;

  list.forEach(drawCard);


}

function drawCard(t) {
  const div = document.createElement("div");
  div.className = "result-card";
  div.innerHTML = cardHTML(t);
  scrollArea.appendChild(div);
}


/* ===== 卡片 HTML ===== */
function cardHTML(track) {
    const artist = track.artists[0].name;
    const title = track.name;
    const preview = track.preview_url;
    const spotifyUrl = track.external_urls.spotify; // 獲取 Spotify 網址

    return `
        <strong>${title}</strong><br>
        歌手：${artist}<br><br>

        <button onclick="loadLyrics('${artist}', '${title}')">歌詞</button>

        ${
            preview
                ? `<button style="margin-left:10px" onclick="playPreview('${preview}')">試聽</button>`
                : `<a href="${spotifyUrl}" target="_blank" style="margin-left:10px; text-decoration:none;">
                     <button style="background:#535353;">在 Spotify 播放</button>
                  </a>`
        }
    `;
}

/* ===== 試聽 ===== */
function playPreview(url) {
  const audio = document.getElementById("audioPlayer");
  audio.style.display = "block";
  audio.src = url;
  audio.play();
}

/* ===== 歌詞 API ===== */
async function loadLyrics(artist, title) {
  lyrics.innerHTML = "<span class='spinner'></span> 取得歌詞…";

  // 使用 Lyrics.ovh API 進行查詢
  const url =
    `https://api.lyrics.ovh/v1/${encodeURIComponent(artist)}/${encodeURIComponent(title)}`;

  try {
    const res = await fetch(url);

    // 檢查 HTTP 狀態碼
    if (!res.ok) {
      lyrics.innerText = "找不到歌詞或 API 發生錯誤";
      return;
    }

    const data = await res.json();

    // 檢查回傳的 JSON 是否包含錯誤信息
    if (data.error) {
      lyrics.innerText = data.error; // 顯示 API 回傳的錯誤
    } else if (data.lyrics) {
      lyrics.innerText = data.lyrics;
    } else {
      lyrics.innerText = "找不到歌詞";
    }

  } catch (error) {
    // 捕獲網路錯誤 (例如：Failed to fetch)
    console.error("Fetch 歌詞失敗:", error);
    lyrics.innerText = "網路連線或伺服器錯誤，無法取得歌詞。";
  }
}

/* ===== 自動解析 Token ===== */
(async function () {
  const code = new URLSearchParams(location.search).get("code");
  if (code) {
    await fetchAccessToken(code);
    history.replaceState({}, "", "music.html");
  }
})();
</script>
</body>
</html>
